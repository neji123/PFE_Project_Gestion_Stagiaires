<app-sidebar [isVisible]="isSidebarVisible" (visibilityChange)="onSidebarVisibilityChange($event)"></app-sidebar>

<div class="main-content" [class.sidebar-open]="isSidebarVisible">
  <div class="admin-container">
    
    <!-- En-tête -->
    <mat-card class="header-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>settings</mat-icon>
          Administration des Types de Rapports
        </mat-card-title>
        <mat-card-subtitle>
          Gérez les types de rapports que les stagiaires doivent soumettre
        </mat-card-subtitle>
        <div class="header-actions">
          <button mat-raised-button color="accent" (click)="initializeDefaults()">
            <mat-icon>auto_fix_high</mat-icon>
            Types par défaut
          </button>
          <button mat-raised-button color="primary" (click)="showCreateForm()" *ngIf="!showForm">
            <mat-icon>add</mat-icon>
            Nouveau type
          </button>
        </div>
      </mat-card-header>
    </mat-card>

    <!-- Formulaire -->
    <mat-card *ngIf="showForm" class="form-card">
      <mat-card-header>
        <mat-card-title>
          {{ isEditing ? 'Modifier' : 'Créer' }} un type de rapport
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <form [formGroup]="reportTypeForm" (ngSubmit)="onSubmit()">
          <div class="form-row">
            <mat-form-field class="full-width">
              <mat-label>Nom du type</mat-label>
              <input matInput formControlName="name" placeholder="Ex: Convention de stage">
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field class="full-width">
              <mat-label>Description</mat-label>
              <textarea matInput formControlName="description" rows="3"></textarea>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field>
              <mat-label>Ordre d'affichage</mat-label>
              <input matInput type="number" formControlName="displayOrder" min="1">
            </mat-form-field>

            <mat-form-field>
              <mat-label>Jours depuis le début</mat-label>
              <input matInput type="number" formControlName="daysFromStart">
              <mat-hint>Positif = après, Négatif = avant</mat-hint>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field>
              <mat-label>Icône</mat-label>
              <mat-select formControlName="iconClass">
                <mat-option *ngFor="let icon of iconOptions" [value]="icon.value">
                  <div class="icon-option">
                    <mat-icon [class]="icon.icon"></mat-icon>
                    <span>{{ icon.label }}</span>
                  </div>
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field>
              <mat-label>Couleur</mat-label>
              <mat-select formControlName="color">
                <mat-option *ngFor="let color of colorOptions" [value]="color.value">
                  <div class="color-option">
                    <div class="color-preview" [style.background-color]="color.color"></div>
                    <span>{{ color.label }}</span>
                  </div>
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="form-row checkboxes">
            <mat-checkbox formControlName="isAutoGenerated">
              Généré automatiquement
            </mat-checkbox>

            <mat-checkbox formControlName="isActive">
              Actif
            </mat-checkbox>
          </div>

          <!-- Aperçu -->
          <div class="preview-section">
            <h4>Aperçu :</h4>
            <div class="type-preview">
              <mat-icon 
                [class]="getIconPreview(reportTypeForm.get('iconClass')?.value)" 
                [style.color]="getColorPreview(reportTypeForm.get('color')?.value)">
              </mat-icon>
              <span>{{ reportTypeForm.get('name')?.value || 'Nom du type' }}</span>
              <small>{{ getDaysText(reportTypeForm.get('daysFromStart')?.value || 0) }}</small>
            </div>
          </div>

          <div class="form-actions">
            <button mat-button type="button" (click)="cancelForm()">Annuler</button>
            <button mat-raised-button color="primary" type="submit" [disabled]="reportTypeForm.invalid">
              {{ isEditing ? 'Sauvegarder' : 'Créer' }}
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Liste des types -->
    <mat-card class="types-card" *ngIf="!showForm">
      <mat-card-header>
        <mat-card-title>
          Types configurés ({{ reportTypes.length }})
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <div *ngIf="isLoading" class="loading-container">
          <mat-spinner></mat-spinner>
          <p>Chargement...</p>
        </div>

        <div *ngIf="error" class="error-container">
          <mat-icon color="warn">error</mat-icon>
          <p>{{ error }}</p>
        </div>

        <div *ngIf="!isLoading && !error && reportTypes.length === 0" class="empty-state">
          <mat-icon class="large-icon">inbox</mat-icon>
          <h3>Aucun type configuré</h3>
          <button mat-raised-button color="primary" (click)="showCreateForm()">
            Créer le premier type
          </button>
        </div>

        <div *ngIf="!isLoading && !error && reportTypes.length > 0" 
             cdkDropList 
             (cdkDropListDropped)="drop($event)">
          
          <table mat-table [dataSource]="reportTypes">
            <!-- Ordre -->
            <ng-container matColumnDef="order">
              <th mat-header-cell *matHeaderCellDef>Ordre</th>
              <td mat-cell *matCellDef="let type" cdkDrag>
                <mat-icon cdkDragHandle>drag_indicator</mat-icon>
                {{ type.displayOrder }}
              </td>
            </ng-container>

            <!-- Nom -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Type</th>
              <td mat-cell *matCellDef="let type">
                <div class="type-info">
                  <div class="type-header">
                    <mat-icon [class]="type.iconClass" [style.color]="type.color"></mat-icon>
                    <span>{{ type.name }}</span>
                  </div>
                  <p class="description">{{ type.description }}</p>
                </div>
              </td>
            </ng-container>

            <!-- Timing -->
            <ng-container matColumnDef="daysFromStart">
              <th mat-header-cell *matHeaderCellDef>Échéance</th>
              <td mat-cell *matCellDef="let type">
                {{ getDaysText(type.daysFromStart) }}
              </td>
            </ng-container>

            <!-- Statut -->
            <ng-container matColumnDef="isActive">
              <th mat-header-cell *matHeaderCellDef>Statut</th>
              <td mat-cell *matCellDef="let type">
                <mat-slide-toggle 
                  [checked]="type.isActive"
                  (change)="toggleActive(type)">
                </mat-slide-toggle>
              </td>
            </ng-container>

            <!-- Auto -->
            <ng-container matColumnDef="isAutoGenerated">
              <th mat-header-cell *matHeaderCellDef>Auto</th>
              <td mat-cell *matCellDef="let type">
                <mat-icon [color]="type.isAutoGenerated ? 'primary' : ''">
                  {{ type.isAutoGenerated ? 'smart_toy' : 'person' }}
                </mat-icon>
              </td>
            </ng-container>

            <!-- Actions -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let type">
                <button mat-icon-button color="accent" (click)="editReportType(type)">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="deleteReportType(type)">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>

  </div>
</div>