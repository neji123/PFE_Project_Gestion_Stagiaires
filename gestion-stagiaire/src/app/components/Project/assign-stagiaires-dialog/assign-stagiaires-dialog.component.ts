import { Component, Inject, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { MatDialogRef, MAT_DIALOG_DATA, MatDialogModule } from '@angular/material/dialog';
import { MatFormFieldModule } from '@angular/material/form-field';
import { MatInputModule } from '@angular/material/input';
import { MatButtonModule } from '@angular/material/button';
import { MatSelectModule } from '@angular/material/select';
import { MatListModule } from '@angular/material/list';
import { MatIconModule } from '@angular/material/icon';
import { MatProgressSpinnerModule } from '@angular/material/progress-spinner';
import { MatCheckboxModule } from '@angular/material/checkbox';

import { UserService } from '../../../services/User/user.service';
import { ProjectService } from '../../../services/Project/project.service';
import { environment } from '../../../environments/environment';
@Component({
  selector: 'app-assign-stagiaires-dialog',
  templateUrl: './assign-stagiaires-dialog.component.html',
  styleUrls: ['./assign-stagiaires-dialog.component.scss'],
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    MatDialogModule,
    MatFormFieldModule,
    MatInputModule,
    MatButtonModule,
    MatSelectModule,
    MatListModule,
    MatIconModule,
    MatCheckboxModule,
    MatProgressSpinnerModule
  ]
})
export class AssignStagiairesDialogComponent implements OnInit {
  // üìã Listes des stagiaires
  availableStagiaires: any[] = [];        // Stagiaires disponibles (non affect√©s)
  filteredStagiaires: any[] = [];         // Stagiaires filtr√©s par recherche
  currentlyAssignedStagiaires: any[] = []; // Stagiaires actuellement dans le projet
  
  // üéØ S√©lections
  selectedStagiaires: string[] = [];       // IDs des stagiaires s√©lectionn√©s
  
  // üîÑ √âtats
  loading = false;
  error: string | null = null;
  
  // üìä Statistiques (optionnelles pour l'affichage)
  stats = {
    totalAvailable: 0,
    totalInProject: 0,
    selectedCount: 0
  };

  constructor(
    public dialogRef: MatDialogRef<AssignStagiairesDialogComponent>,
    @Inject(MAT_DIALOG_DATA) public data: { projectId: number, projectTitle: string },
    private userService: UserService,
    private projectService: ProjectService
  ) {}

  ngOnInit(): void {
    console.log(`üöÄ Initialisation du dialogue pour le projet: ${this.data.projectTitle} (ID: ${this.data.projectId})`);
    this.loadData();
  }

  /**
   * üîÑ Charge toutes les donn√©es n√©cessaires
   */
  async loadData(): Promise<void> {
    this.loading = true;
    this.error = null;

    try {
      // Charger en parall√®le les stagiaires disponibles et ceux actuellement assign√©s
      const [availableStagiaires, currentAssignments] = await Promise.all([
        this.loadAvailableStagiaires(),
        this.loadCurrentlyAssignedStagiaires()
      ]);

      console.log('‚úÖ Toutes les donn√©es charg√©es avec succ√®s');
      this.updateStats();
      
    } catch (error) {
      console.error('‚ùå Erreur lors du chargement des donn√©es:', error);
      this.error = 'Erreur lors du chargement des donn√©es';
    } finally {
      this.loading = false;
    }
  }

  /**
   * üì• Charge les stagiaires disponibles (non affect√©s √† aucun projet)
   */
private loadAvailableStagiaires(): Promise<any[]> {
  console.log('üé® Chargement des stagiaires disponibles avec style EY...');
  
  return new Promise((resolve, reject) => {
    this.userService.getUnassignedStagiaires().subscribe({
      next: (stagiaires) => {
        console.log(`‚úÖ ${stagiaires.length} stagiaires NON AFFECT√âS charg√©s`);
        
        // üìä Log d√©taill√© pour d√©bogage
        if (stagiaires.length === 0) {
          console.log('‚ö†Ô∏è Aucun stagiaire disponible - tous sont d√©j√† affect√©s √† des projets');
        } else {
          stagiaires.forEach(s => {
            console.log(`üìã Disponible: ${s.firstName} ${s.lastName} (ID: ${s.id})`);
            console.log(`   üìß Email: ${s.email}`);
            console.log(`   üë§ Username: ${s.username}`);
            console.log(`   üè´ Universit√©: ${s.university}`);
            console.log(`   üè¢ D√©partement: ${s.department}`);
          });
        }
        
        this.availableStagiaires = stagiaires;
        this.filteredStagiaires = [...stagiaires];
        resolve(stagiaires);
      },
      error: (err) => {
        console.error('‚ùå Erreur lors du chargement des stagiaires disponibles:', err);
        reject(err);
      }
    });
  });
}


  /**
 * G√©n√®re les initiales pour l'avatar
 */
getInitials(firstName: string, lastName: string): string {
  return firstName && lastName
    ? `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase()
    : '??';
}

/**
 * G√©n√®re une couleur de fond bas√©e sur le nom
 */
getAvatarColor(firstName: string, lastName: string): string {
  const name = `${firstName}${lastName}`;
  let hash = 0;
  for (let i = 0; i < name.length; i++) {
    hash = name.charCodeAt(i) + ((hash << 5) - hash);
  }
  
  const h = Math.abs(hash % 360);
  return `hsl(${h}, 70%, 60%)`;
}

/**
 * Gestion des images avec URL compl√®te
 */
 // M√©thode pour g√©rer correctement les URLs d'images
  getImageUrl(relativeUrl: string | null): string {
    if (!relativeUrl) return 'assets/images/default-profile.jpg';
    
    // Si c'est d√©j√† une URL compl√®te, retournez-la telle quelle
    if (relativeUrl.startsWith('http')) return relativeUrl;
    
    // Sinon, pr√©fixez avec l'URL du backend
    return `${environment.apiUrl}${relativeUrl}`;
  }

/**
 * Gestion des erreurs d'image
 */
handleImageError(event: Event): void {
  const img = event.target as HTMLImageElement;
  img.src = 'assets/images/default-profile.jpg';
}

  /**
   * üì• Charge les stagiaires actuellement assign√©s au projet
   */
  private loadCurrentlyAssignedStagiaires(): Promise<any[]> {
    console.log('üì• Chargement des stagiaires actuellement assign√©s...');
    
    return new Promise((resolve, reject) => {
      this.projectService.getProjectUsers(this.data.projectId).subscribe({
        next: (users) => {
          // Filtrer uniquement les stagiaires (au cas o√π il y aurait d'autres r√¥les)
          const assignedStagiaires = users.filter(user => user.role === 'Stagiaire');
          
          console.log(`‚úÖ ${assignedStagiaires.length} stagiaires actuellement assign√©s au projet`);
          this.currentlyAssignedStagiaires = assignedStagiaires;
          
          // Initialiser les s√©lections avec les stagiaires d√©j√† assign√©s
          this.selectedStagiaires = assignedStagiaires
            .map(s => (s.id || s.userId || '').toString())
            .filter(id => id);
          
          console.log('üéØ S√©lections initiales:', this.selectedStagiaires);
          resolve(assignedStagiaires);
        },
        error: (err) => {
          console.error('‚ùå Erreur lors du chargement des stagiaires assign√©s:', err);
          // Continuer m√™me en cas d'erreur (projet sans stagiaires assign√©s)
          this.currentlyAssignedStagiaires = [];
          this.selectedStagiaires = [];
          resolve([]);
        }
      });
    });
  }

 /**
 * üîç Filtrage am√©lior√© des stagiaires
 */
filterStagiaires(searchTerm: string, selectedDepartment?: string): void {
  console.log(`üîç Filtrage avec terme: "${searchTerm}" et d√©partement: "${selectedDepartment}"`);
  
  if ((!searchTerm || searchTerm.trim() === '') && !selectedDepartment) {
    this.filteredStagiaires = [...this.availableStagiaires];
    console.log(`üìã Affichage de tous les ${this.filteredStagiaires.length} stagiaires`);
    return;
  }
  
  const term = searchTerm ? searchTerm.toLowerCase().trim() : '';
  
  this.filteredStagiaires = this.availableStagiaires.filter(stagiaire => {
    // Filtre par terme de recherche
    let matchesSearch = true;
    if (term) {
      const searchFields = [
        stagiaire.firstName,
        stagiaire.lastName,
        stagiaire.email,
        stagiaire.username,
        stagiaire.university,
        stagiaire.department
      ];
      
      matchesSearch = searchFields.some(field => 
        field && field.toLowerCase().includes(term)
      );
    }
    
    // Filtre par d√©partement
    let matchesDepartment = true;
    if (selectedDepartment && selectedDepartment !== '') {
      matchesDepartment = stagiaire.department === selectedDepartment;
    }
    
    return matchesSearch && matchesDepartment;
  });
  
  console.log(`üìã ${this.filteredStagiaires.length} stagiaires trouv√©s apr√®s filtrage`);
}

// Nouvelle m√©thode pour obtenir la liste des d√©partements
getDepartments(): string[] {
  const departments = this.availableStagiaires
    .map(s => s.department)
    .filter(dept => dept && dept.trim() !== '')
    .filter((dept, index, arr) => arr.indexOf(dept) === index) // Supprimer les doublons
    .sort();
  
  return departments;
}
  
  /**
   * ‚úÖ V√©rifie si un stagiaire est s√©lectionn√©
   */
  isSelected(stagiaireId: string): boolean {
    const id = stagiaireId.toString();
    return this.selectedStagiaires.includes(id);
  }

 /**
 * üîÑ Bascule la s√©lection avec feedback visuel
 */
toggleSelection(stagiaireId: string): void {
  const id = stagiaireId.toString();
  console.log(`üé® EY - Basculement de la s√©lection pour le stagiaire ${id}`);
  
  const index = this.selectedStagiaires.indexOf(id);
  if (index === -1) {
    this.selectedStagiaires.push(id);
    console.log(`‚úÖ EY - Stagiaire ${id} ajout√© √† la s√©lection`);
    
    // Trouver le stagiaire pour log d√©taill√©
    const stagiaire = this.availableStagiaires.find(s => s.id.toString() === id);
    if (stagiaire) {
      console.log(`   üë§ ${stagiaire.firstName} ${stagiaire.lastName} s√©lectionn√©`);
    }
  } else {
    this.selectedStagiaires.splice(index, 1);
    console.log(`‚ùå EY - Stagiaire ${id} retir√© de la s√©lection`);
  }
  
  this.updateStats();
  console.log('üéØ S√©lection EY actuelle:', this.selectedStagiaires);
}

/**
 * üéØ Mise √† jour des statistiques avec animations
 */
private updateStats(): void {
  this.stats = {
    totalAvailable: this.availableStagiaires.length,
    totalInProject: this.currentlyAssignedStagiaires.length,
    selectedCount: this.selectedStagiaires.length
  };
  
  console.log('üìä Statistiques mises √† jour:', this.stats);
}

  /**
   * ‚ùå Annule et ferme le dialogue
   */
  onCancel(): void {
    console.log('‚ùå Annulation du dialogue');
    this.dialogRef.close(false);
  }

 /**
 * üíæ Sauvegarde avec feedback EY
 */
onSave(): void {
  console.log('üíæ EY - Sauvegarde des modifications...');
  console.log('üéØ Stagiaires s√©lectionn√©s EY:', this.selectedStagiaires);
  console.log('üìã Stagiaires actuellement assign√©s:', this.currentlyAssignedStagiaires.map(s => s.id));
  
  this.loading = true;
  
  // Calculer les diff√©rences
  const currentlyAssignedIds = this.currentlyAssignedStagiaires.map(s => String(s.id));
  const stagiaireIdsToAdd = this.selectedStagiaires.filter(id => !currentlyAssignedIds.includes(String(id)));
  const stagiaireIdsToRemove = currentlyAssignedIds.filter(id => !this.selectedStagiaires.includes(String(id)));
  
  console.log('‚ú® EY - Modifications √† apporter:');
  console.log('‚ûï Stagiaires √† ajouter:', stagiaireIdsToAdd);
  console.log('‚ûñ Stagiaires √† retirer:', stagiaireIdsToRemove);
  
  // Si aucun changement, fermer simplement
  if (stagiaireIdsToAdd.length === 0 && stagiaireIdsToRemove.length === 0) {
    console.log('‚ÑπÔ∏è EY - Aucun changement d√©tect√©');
    this.dialogRef.close(false);
    return;
  }
  
  // Envoyer les modifications au serveur
  this.projectService.updateProjectUsers(this.data.projectId, stagiaireIdsToAdd, stagiaireIdsToRemove)
    .subscribe({
      next: (response) => {
        console.log('‚úÖ EY - Modifications sauvegard√©es avec succ√®s:', response);
        
        // Log des stagiaires affect√©s avec leurs noms
        stagiaireIdsToAdd.forEach(id => {
          const stagiaire = this.availableStagiaires.find(s => s.id.toString() === id);
          if (stagiaire) {
            console.log(`üéâ ${stagiaire.firstName} ${stagiaire.lastName} affect√© au projet "${this.data.projectTitle}"`);
          }
        });
        
        this.loading = false;
        this.dialogRef.close(true);
      },
      error: (err) => {
        console.error('‚ùå EY - Erreur lors de la sauvegarde:', err);
        this.error = 'Erreur lors de la sauvegarde des modifications';
        this.loading = false;
      }
    });
}

  /**
   * üîÑ Rafra√Æchit les donn√©es
   */
  refreshData(): void {
    console.log('üîÑ Rafra√Æchissement des donn√©es...');
    this.loadData();
  }

  /**
   * üß™ M√©thode de test pour d√©bogage
   */
  testAddRemove(): void {
    console.log('üß™ === TEST DE S√âLECTION ===');
    console.log('üìä Statistiques actuelles:', this.stats);
    console.log('üìã Stagiaires disponibles:', this.availableStagiaires.length);
    console.log('üìã Stagiaires actuellement assign√©s:', this.currentlyAssignedStagiaires.length);
    console.log('üéØ Stagiaires s√©lectionn√©s:', this.selectedStagiaires);
    console.log('üß™ === FIN DU TEST ===');
  }
}